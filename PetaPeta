local Players = game:GetService("Players")
local player = Players.LocalPlayer

local function createMainGui()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "BayuHubUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    -- Frame utama
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.BackgroundColor3 = Color3.new(0,0,0)
    MainFrame.Size = UDim2.new(0.7, 0, 0.5, 0)
    MainFrame.Position = UDim2.new(0.15, 0, 0.25, 0)
    MainFrame.BorderSizePixel = 2
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui

    -- Sidebar kiri
    local Sidebar = Instance.new("Frame")
    Sidebar.Name = "Sidebar"
    Sidebar.BackgroundColor3 = Color3.new(0,0,0)
    Sidebar.Size = UDim2.new(0.24, 0, 1, 0)
    Sidebar.Position = UDim2.new(0, 0, 0, 0)
    Sidebar.BorderSizePixel = 0
    Sidebar.Parent = MainFrame

    -- Label "Bayu hub"
    local Title = Instance.new("TextLabel")
    Title.Text = "Bayu hub"
    Title.Font = Enum.Font.SourceSansBold
    Title.TextSize = 30
    Title.TextColor3 = Color3.new(1,1,1)
    Title.BackgroundTransparency = 1
    Title.Size = UDim2.new(1, -10, 0, 48)
    Title.Position = UDim2.new(0, 5, 0, 12)
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = Sidebar

    -- Garis hiasan di bawah tulisan "Bayu hub"
    local Decoration = Instance.new("Frame")
    Decoration.Size = UDim2.new(1, -20, 0, 3)
    Decoration.Position = UDim2.new(0, 10, 0, 56)
    Decoration.BackgroundColor3 = Color3.fromRGB(0,120,255)
    Decoration.BorderSizePixel = 0
    Decoration.Parent = Sidebar

    -- Tab Buttons (2 tab)
    local tabNames = {"ESP", "Kosong"}
    local tabButtons = {}
    local TabsFrame = Instance.new("Frame")
    TabsFrame.Name = "TabsFrame"
    TabsFrame.Position = UDim2.new(0, 0, 0, 70)
    TabsFrame.Size = UDim2.new(1, 0, 0, 90)
    TabsFrame.BackgroundTransparency = 1
    TabsFrame.Parent = Sidebar

    local layout = Instance.new("UIListLayout")
    layout.Parent = TabsFrame
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 12)

    for i, name in ipairs(tabNames) do
        local Button = Instance.new("TextButton")
        Button.Text = name
        Button.Font = Enum.Font.SourceSans
        Button.TextSize = 24
        Button.TextColor3 = Color3.new(1,1,1)
        Button.BackgroundColor3 = Color3.fromRGB(30,30,30)
        Button.BorderColor3 = Color3.fromRGB(180,180,180)
        Button.Size = UDim2.new(1, -16, 0, 38)
        Button.LayoutOrder = i
        Button.Parent = TabsFrame
        tabButtons[i] = Button
    end

    -- Garis pembatas vertikal
    local Separator = Instance.new("Frame")
    Separator.Name = "Separator"
    Separator.Size = UDim2.new(0, 2, 1, 0)
    Separator.Position = UDim2.new(0.24, 0, 0, 0)
    Separator.BackgroundColor3 = Color3.fromRGB(180,180,180)
    Separator.BorderSizePixel = 0
    Separator.Parent = MainFrame
    Separator.ZIndex = 10

    -- Header bar
    local Header = Instance.new("Frame")
    Header.BackgroundColor3 = Color3.fromRGB(30,30,30)
    Header.Size = UDim2.new(0.76, 0, 0, 38)
    Header.Position = UDim2.new(0.24, 0, 0, 0)
    Header.Parent = MainFrame

    -- Tombol minimize
    local MinButton = Instance.new("TextButton")
    MinButton.Text = "-"
    MinButton.Font = Enum.Font.SourceSansBold
    MinButton.TextSize = 26
    MinButton.TextColor3 = Color3.new(1,1,1)
    MinButton.BackgroundTransparency = 1
    MinButton.Size = UDim2.new(0, 38, 0, 38)
    MinButton.Position = UDim2.new(1, -80, 0, 0)
    MinButton.Parent = Header

    -- Tombol close
    local CloseButton = Instance.new("TextButton")
    CloseButton.Text = "Ã—"
    CloseButton.Font = Enum.Font.SourceSansBold
    CloseButton.TextSize = 26
    CloseButton.TextColor3 = Color3.new(1,1,1)
    CloseButton.BackgroundTransparency = 1
    CloseButton.Size = UDim2.new(0, 38, 0, 38)
    CloseButton.Position = UDim2.new(1, -38, 0, 0)
    CloseButton.Parent = Header

    -- Konten utama
    local Content = Instance.new("Frame")
    Content.BackgroundColor3 = Color3.new(0,0,0)
    Content.Position = UDim2.new(0.24, 2, 0, 38)
    Content.Size = UDim2.new(0.76, -2, 1, -38)
    Content.Parent = MainFrame

    -- ESP Page (tampil hanya di tab 1)
    local ESPPage = Instance.new("Frame")
    ESPPage.Name = "ESPPage"
    ESPPage.BackgroundTransparency = 1
    ESPPage.Size = UDim2.new(1, 0, 1, 0)
    ESPPage.Position = UDim2.new(0,0,0,0)
    ESPPage.Parent = Content

    -- ESP Buttons (Peta, Key, Pumpkin)
    local espNames = {{"ESP Map", "Peta"}, {"ESP Key", "Key"}, {"ESP Pumpkin", "Pumpkin"}}
    local espButtons = {}
    local espLayout = Instance.new("UIListLayout")
    espLayout.Parent = ESPPage
    espLayout.SortOrder = Enum.SortOrder.LayoutOrder
    espLayout.Padding = UDim.new(0, 14)
    ESPPage.Padding = UDim.new(0, 16)

    -- ESP states
    local isEspMapActive = false
    local isEspKeyActive = false
    local isEspPumpkinActive = false
    local stopEspMap, stopEspKey, stopEspPumpkin

    for i, v in ipairs(espNames) do
        local btn = Instance.new("TextButton")
        btn.Text = v[1]
        btn.Font = Enum.Font.SourceSansBold
        btn.TextSize = 24
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.BackgroundColor3 = Color3.fromRGB(30,30,30)
        btn.BorderColor3 = Color3.fromRGB(180,180,180)
        btn.Size = UDim2.new(0, 190, 0, 42)
        btn.LayoutOrder = i
        btn.Parent = ESPPage
        espButtons[i] = btn
    end

    -- "Kosong" page (tab 2)
    local EmptyPage = Instance.new("Frame")
    EmptyPage.Name = "EmptyPage"
    EmptyPage.BackgroundTransparency = 1
    EmptyPage.Size = UDim2.new(1, 0, 1, 0)
    EmptyPage.Position = UDim2.new(0,0,0,0)
    EmptyPage.Parent = Content
    EmptyPage.Visible = false

    local EmptyLabel = Instance.new("TextLabel")
    EmptyLabel.Text = "Belum ada isi"
    EmptyLabel.Font = Enum.Font.SourceSans
    EmptyLabel.TextSize = 30
    EmptyLabel.TextColor3 = Color3.fromRGB(220,220,220)
    EmptyLabel.BackgroundTransparency = 1
    EmptyLabel.Size = UDim2.new(1, 0, 1, 0)
    EmptyLabel.Position = UDim2.new(0,0,0,0)
    EmptyLabel.Parent = EmptyPage

    -- ==== ESP MAP ====
    local function runEspMap()
        if isEspMapActive then return end
        isEspMapActive = true
        local running = true
        local highlights = {}
        local SectionPanel = Instance.new("Folder")
        SectionPanel.Name = "ESPMAP"
        SectionPanel.Parent = ESPPage

        local TARGET_PATHS = {
            "Workspace.Client.Enemy.ClientEnemy.petapeta_HW.Monster_Low",
            "Workspace.Client.Enemy.ClientEnemy.petapeta_HW.Hair",
            "Workspace.Client.Enemy.ClientEnemy.petapeta_HW.Ofuda",
            "Workspace.Client.Enemy.ClientEnemy.petapeta_HW.rope"
        }

        local function getInstanceFromPath(path)
            local cur = game
            for seg in path:gmatch("[^%.]+") do
                cur = cur:FindFirstChild(seg)
                if not cur then return nil end
            end
            return cur
        end
        local function clearHighlights()
            for _, h in ipairs(highlights) do
                if h and h.Parent then h:Destroy() end
            end
            table.clear(highlights)
        end
        local function makeHighlight(part)
            if not part:IsA("BasePart") then return end
            local h = Instance.new("Highlight")
            h.Adornee = part
            h.Parent = part
            h.FillColor = Color3.fromRGB(255, 0, 0)
            h.OutlineColor = Color3.fromRGB(255, 0, 0)
            h.FillTransparency = 0.7
            h.OutlineTransparency = 0.1
            table.insert(highlights, h)
        end
        local function applyHighlights()
            clearHighlights()
            for _, path in ipairs(TARGET_PATHS) do
                local obj = getInstanceFromPath(path)
                if obj then
                    if obj:IsA("BasePart") then
                        makeHighlight(obj)
                    else
                        for _, v in ipairs(obj:GetDescendants()) do
                            if v:IsA("BasePart") then
                                makeHighlight(v)
                            end
                        end
                    end
                end
            end
        end
        local function showNotice()
            local gui = Instance.new("ScreenGui")
            gui.ResetOnSpawn = false
            gui.Parent = player:WaitForChild("PlayerGui")
            local text = Instance.new("TextLabel")
            text.Size = UDim2.new(1, 0, 0, 40)
            text.AnchorPoint = Vector2.new(0.5, 0)
            text.Position = UDim2.new(0.5, 0, 0, 40)
            text.BackgroundTransparency = 1
            text.Text = "ðŸ—ºï¸ Map: Wes metu"
            text.TextColor3 = Color3.fromRGB(255, 0, 0)
            text.TextStrokeTransparency = 0.4
            text.Font = Enum.Font.SourceSansBold
            text.TextSize = 28
            text.Parent = gui
            task.delay(5, function()
                gui:Destroy()
            end)
        end
        local lastVisible = false
        task.spawn(function()
            while running and SectionPanel.Parent do
                local visible = false
                for _, path in ipairs(TARGET_PATHS) do
                    if getInstanceFromPath(path) then
                        visible = true
                        break
                    end
                end
                if visible and not lastVisible then
                    showNotice()
                    applyHighlights()
                elseif visible then
                    applyHighlights()
                elseif not visible and lastVisible then
                    clearHighlights()
                end
                lastVisible = visible
                task.wait(2.5)
            end
            clearHighlights()
            SectionPanel:Destroy()
        end)
        stopEspMap = function()
            running = false
            isEspMapActive = false
        end
    end

    -- ==== ESP KEY ====
    local function runEspKey()
        if isEspKeyActive then return end
        isEspKeyActive = true
        local running = true
        local keyEsp = Instance.new("Folder")
        keyEsp.Name = "KEYESP"
        keyEsp.Parent = ESPPage
        local Workspace = game:GetService("Workspace")
        local tagged = {}
        local function attachESP(model)
            if tagged[model] then return end
            tagged[model] = true
            local target = model:IsA("Model") and model:FindFirstChildWhichIsA("BasePart") or model
            if not target then return end
            local esp = Instance.new("BillboardGui")
            esp.Name = "ESPLabel"
            esp.Size = UDim2.new(0, 100, 0, 25)
            esp.AlwaysOnTop = true
            esp.StudsOffset = Vector3.new(0, 3, 0)
            esp.Parent = target
            local text = Instance.new("TextLabel")
            text.Size = UDim2.new(1, 0, 1, 0)
            text.BackgroundTransparency = 1
            text.Text = "Key"
            text.TextColor3 = Color3.fromRGB(255, 0, 0)
            text.TextStrokeTransparency = 0
            text.TextScaled = true
            text.Font = Enum.Font.SourceSansBold
            text.Parent = esp
            keyEsp.Destroying:Connect(function()
                if esp and esp.Parent then esp:Destroy() end
                tagged[model] = nil
            end)
        end
        task.spawn(function()
            while running and keyEsp.Parent do
                for _, obj in ipairs(Workspace:GetDescendants()) do
                    if string.find(string.lower(obj.Name), "key") then
                        local top = obj
                        while top.Parent and not top.Parent:IsA("Workspace") and not tagged[top.Parent] and string.find(string.lower(top.Parent.Name), "key") do
                            top = top.Parent
                        end
                        attachESP(top)
                    end
                end
                task.wait(3)
            end
            keyEsp:Destroy()
        end)
        stopEspKey = function()
            running = false
            isEspKeyActive = false
        end
    end

    -- ==== ESP PUMPKIN ====
    local function runEspPumpkin()
        if isEspPumpkinActive then return end
        isEspPumpkinActive = true
        local running = true
        local pumpkinEsp = Instance.new("Folder")
        pumpkinEsp.Name = "PUMPKINESP"
        pumpkinEsp.Parent = ESPPage
        local targetMeshId = "rbxassetid://84793702900063"
        local function highlightPumpkin(v)
            if not v:FindFirstChild("PumpkinESP") then
                local hl = Instance.new("Highlight")
                hl.Name = "PumpkinESP"
                hl.FillColor = Color3.fromRGB(255, 80, 0)
                hl.FillTransparency = 0.6
                hl.OutlineTransparency = 1
                hl.Adornee = v
                hl.Parent = v
            end
        end
        local function isPumpkin(v)
            if not v:IsA("MeshPart") then return false end
            if v.MeshId ~= targetMeshId then return false end
            local s = v.Size
            local c = v.Color
            if s.X > 0.6 and s.X < 0.9 and s.Y > 0.6 and s.Y < 0.9 and s.Z > 0.6 and s.Z < 0.9 then
                if c.r > 0.5 and c.r < 0.7 and c.g > 0.5 and c.g < 0.7 and c.b > 0.5 and c.b < 0.7 then
                    return true
                end
            end
            return false
        end
        for _, v in ipairs(workspace:GetDescendants()) do
            if isPumpkin(v) then highlightPumpkin(v) end
        end
        local conn
        conn = workspace.DescendantAdded:Connect(function(v)
            if isPumpkin(v) then
                task.wait(0.1)
                highlightPumpkin(v)
            end
        end)
        pumpkinEsp.Destroying:Connect(function()
            if conn then conn:Disconnect() end
            for _, v in ipairs(workspace:GetDescendants()) do
                local h = v:FindFirstChild("PumpkinESP")
                if h then h:Destroy() end
            end
        end)
        stopEspPumpkin = function()
            pumpkinEsp:Destroy()
            isEspPumpkinActive = false
        end
    end

    -- ESP Button Clicks (toggle ON/OFF)
    espButtons[1].MouseButton1Click:Connect(function()
        if not isEspMapActive then
            runEspMap()
            espButtons[1].BackgroundColor3 = Color3.fromRGB(0, 180, 90)
        else
            if stopEspMap then stopEspMap() end
            espButtons[1].BackgroundColor3 = Color3.fromRGB(30,30,30)
        end
    end)
    espButtons[2].MouseButton1Click:Connect(function()
        if not isEspKeyActive then
            runEspKey()
            espButtons[2].BackgroundColor3 = Color3.fromRGB(0, 180, 90)
        else
            if stopEspKey then stopEspKey() end
            espButtons[2].BackgroundColor3 = Color3.fromRGB(30,30,30)
        end
    end)
    espButtons[3].MouseButton1Click:Connect(function()
        if not isEspPumpkinActive then
            runEspPumpkin()
            espButtons[3].BackgroundColor3 = Color3.fromRGB(0, 180, 90)
        else
            if stopEspPumpkin then stopEspPumpkin() end
            espButtons[3].BackgroundColor3 = Color3.fromRGB(30,30,30)
        end
    end)

    -- Tab logic
    tabButtons[1].MouseButton1Click:Connect(function()
        ESPPage.Visible = true
        EmptyPage.Visible = false
    end)
    tabButtons[2].MouseButton1Click:Connect(function()
        ESPPage.Visible = false
        EmptyPage.Visible = true
    end)

    -- Tombol minimize (ðŸ—¿) di luar MainFrame
    local MiniButton = Instance.new("TextButton")
    MiniButton.Name = "MiniButton"
    MiniButton.Size = UDim2.new(0, 56, 0, 56)
    MiniButton.Position = UDim2.new(0, 32, 1, -88)
    MiniButton.AnchorPoint = Vector2.new(0,1)
    MiniButton.Text = "ðŸ—¿"
    MiniButton.Font = Enum.Font.SourceSansBold
    MiniButton.TextSize = 36
    MiniButton.TextColor3 = Color3.new(1,1,1)
    MiniButton.BackgroundColor3 = Color3.fromRGB(40,40,40)
    MiniButton.BorderSizePixel = 0
    MiniButton.Parent = ScreenGui
    MiniButton.Visible = false
    MiniButton.AutoButtonColor = true

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(1, 0)
    UICorner.Parent = MiniButton

    -- Drag logic untuk MiniButton
    local dragging, dragInput, dragStart, startPos
    MiniButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = MiniButton.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    MiniButton.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            local newPos = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
            MiniButton.Position = newPos
        end
    end)

    -- Minimize
    MinButton.MouseButton1Click:Connect(function()
        MainFrame.Visible = false
        MiniButton.Visible = true
    end)
    MiniButton.MouseButton1Click:Connect(function()
        MainFrame.Visible = true
        MiniButton.Visible = false
    end)

    -- Tombol close (konfirmasi)
    local function showConfirm(mainGui)
        local ConfirmGui = Instance.new("ScreenGui")
        ConfirmGui.Name = "ConfirmGui"
        ConfirmGui.Parent = player.PlayerGui

        local ConfirmFrame = Instance.new("Frame")
        ConfirmFrame.AnchorPoint = Vector2.new(0.5,0.5)
        ConfirmFrame.Size = UDim2.new(0.3, 0, 0.22, 0)
        ConfirmFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
        ConfirmFrame.BackgroundColor3 = Color3.new(0,0,0)
        ConfirmFrame.BackgroundTransparency = 0.2
        ConfirmFrame.Parent = ConfirmGui

        local ConfirmLabel = Instance.new("TextLabel")
        ConfirmLabel.Text = "are u sure?"
        ConfirmLabel.Font = Enum.Font.SourceSansBold
        ConfirmLabel.TextSize = 32
        ConfirmLabel.TextColor3 = Color3.new(1,1,1)
        ConfirmLabel.BackgroundTransparency = 1
        ConfirmLabel.Size = UDim2.new(1, 0, 0.5, 0)
        ConfirmLabel.Position = UDim2.new(0, 0, 0, 0)
        ConfirmLabel.Parent = ConfirmFrame

        local NoButton = Instance.new("TextButton")
        NoButton.Text = "No"
        NoButton.Font = Enum.Font.SourceSansBold
        NoButton.TextSize = 26
        NoButton.TextColor3 = Color3.new(1,1,1)
        NoButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
        NoButton.Size = UDim2.new(0.45, 0, 0.32, 0)
        NoButton.Position = UDim2.new(0.05, 0, 0.6, 0)
        NoButton.Parent = ConfirmFrame

        local YesButton = Instance.new("TextButton")
        YesButton.Text = "Yes"
        YesButton.Font = Enum.Font.SourceSansBold
        YesButton.TextSize = 26
        YesButton.TextColor3 = Color3.new(1,1,1)
        YesButton.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        YesButton.Size = UDim2.new(0.45, 0, 0.32, 0)
        YesButton.Position = UDim2.new(0.5, 0, 0.6, 0)
        YesButton.Parent = ConfirmFrame

        NoButton.MouseButton1Click:Connect(function()
            ConfirmGui:Destroy()
            mainGui.Enabled = true
        end)
        YesButton.MouseButton1Click:Connect(function()
            ConfirmGui:Destroy()
            mainGui:Destroy()
        end)
    end

    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui.Enabled = false
        showConfirm(ScreenGui)
    end)
end

createMainGui()
